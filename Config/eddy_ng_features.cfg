[gcode_macro SET_TOOL_Z_OFFSET]
gcode:
    {% if 'VALUE' not in params %}
        RESPOND MSG="SET_TOOL_Z_OFFSET: missing VALUE="
        ERROR
    {% endif %}

    {% set T = printer["pin_watch io"].current_tool|int %}
    {% if T < 0 %}
        RESPOND MSG="SET_TOOL_Z_OFFSET: current_tool = -1 (no tool installed)"
        ERROR
    {% endif %}

    {% set v = params.VALUE|float %}

    {% if T == 0 %}
        SET_GCODE_VARIABLE MACRO=GLOBAL_STATE VARIABLE=t0_probe_z VALUE={v}
        RESPOND MSG="SET_TOOL_Z_OFFSET: stored t0_probe_z={v}"
    {% else %}
        {% set base = printer["gcode_macro GLOBAL_STATE"].t0_probe_z|float %}
        {% set delta = v -base %}
        {% set varname = ("t%d_off_z" % T) %}
        SET_GCODE_VARIABLE MACRO=TOOL_OFFSET VARIABLE={varname} VALUE={delta}
        RESPOND MSG="SET_TOOL_Z_OFFSET: set TOOL_OFFSET.{varname}={delta} (v={v}, base={base})"
    {% endif %}


[gcode_macro TOOL_Z_CALIBRATION]
gcode:
    {% set N = printer["gcode_macro GLOBAL_STATE"].max_tool|int %}
    G28

    {% for i in range(N) %}
        M104 T{i} S150
    {% endfor %}
    M109 T0 S150

    SET T=0
    CLEAN
    G90
    G1 X115 Y110 F12000
    PROBE_EDDY_NG_TAP
    G1 X115 Y110 F12000
    PROBE_EDDY_NG_TOOL_TAP

    {% for i in range(1, N) %}
        SET T={i}
        CLEAN
        G1 X115 Y110 F12000
        PROBE_EDDY_NG_TOOL_TAP
    {% endfor %}

    RESPOND MSG="TOOL_Z_CALIBRATION done."
    TOOL_Z_SAVE
    DROP_CLOSE
    G1 X10 Y210 F12000

    {% for i in range(N) %}
        M104 T{i} S0
    {% endfor %}


[gcode_macro TOOL_Z_SAVE]
gcode:
    {% set N = printer["gcode_macro GLOBAL_STATE"].max_tool|int %}
    {% set ns = namespace(msg="T0=0") %}

    {% for i in range(1, N) %}
        {% set kz = "t" ~ i ~ "_off_z" %}
        {% set z  = printer["gcode_macro TOOL_OFFSET"][kz]|float %}

        SAVE_VARIABLE VARIABLE={"t" ~ i ~ "_gcode_z_offset"} VALUE={z}
        {% set ns.msg = ns.msg ~ " T" ~ i ~ "=" ~ ("%.3f"|format(z)) %}
    {% endfor %}

    {action_respond_info("TOOL_Z_SAVE: saved (" ~ ns.msg ~ ")")}

